<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa DWDM — v11-fix (parser tolerante)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<!-- JSON5 para aceitar vírgulas finais, comentários, aspas simples etc. -->
<script src="https://cdn.jsdelivr.net/npm/json5@2.2.3/dist/index.min.js"></script>

<style>
  :root{ --bg:#f6f7fb; --fg:#111; --muted:#374151; --card:#fff; --bd:#e5e7eb; }
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
  #map{position:absolute; inset:0}

  .toolbar{position:absolute;top:14px;left:14px;z-index:1000;background:var(--card);border:1px solid var(--bd);border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,.06)}
  .toolbar .group{padding:10px;border-bottom:1px solid var(--bd)}
  .toolbar .group:last-child{border-bottom:0}
  .toolbar label{display:block;font-weight:600;color:#111;margin:0 0 6px 0}
  .toolbar input[type="text"], .toolbar select{width:230px;padding:8px 10px;border:1px solid var(--bd);border-radius:10px}
  .toolbar .row{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
  .toolbar .row button{padding:8px 10px;border:1px solid var(--bd);background:#fff;border-radius:10px;cursor:pointer}
  .toolbar .row button[aria-pressed="true"]{background:#f3f4f6}
  .toolbar small{color:#6b7280}

  .pillset{display:flex;flex-wrap:wrap;gap:6px}
  .pillset label{display:inline-flex;align-items:center;border:1px solid var(--bd);border-radius:999px;padding:5px 10px;gap:8px;cursor:pointer}
  .pillset input{appearance:none;width:14px;height:14px;border:1px solid var(--bd);border-radius:50%}
  .pillset input:checked{background:#111}

  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--bd);border-radius:999px;padding:4px 8px}
  .chip .x{cursor:pointer;opacity:.6}

  .legend{position:absolute;right:14px;top:14px;z-index:1000;background:var(--card);border:1px solid var(--bd);border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,.06)}
  .legend .group{padding:10px;border-bottom:1px solid var(--bd)}
  .legend .group:last-child{border-bottom:0}
  .legend-clients{max-height:300px;overflow:auto;min-width:220px}
  .legend-clients .row{display:flex;align-items:center;gap:8px;padding:6px 4px}
  .legend-clients .sw{width:18px; height:12px; border-radius:3px; border:1px solid var(--bd)}
  .legend-clients .row label{display:flex; align-items:center; gap:8px; flex:1; cursor:pointer}

  .credit{position:absolute; left:14px; bottom:14px; z-index:1000; color:#374151; font-size:12px; background:var(--card);
          border:1px solid var(--bd); border-radius:10px; padding:6px 8px}

  .leaflet-control-container .leaflet-top,.leaflet-control-container .leaflet-bottom{z-index:1500}

  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; align-items:center; justify-content:center; z-index:2000; }
  .modal .card{ background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:16px; width:min(760px,96vw); box-shadow:0 10px 40px rgba(0,0,0,.15); }
  .modal .row{ display:flex; gap:10px; margin:8px 0; align-items:center; }
  .modal label{ width:170px; color:#374151; font-size:13px; }
  .modal input, .modal select{ flex:1; padding:8px; border:1px solid var(--bd); border-radius:8px; }

  .pillset button, .pillset input, .modal button{ cursor:pointer }
</style>
</head>
<body>
<div id="map"></div>

<div class="toolbar" role="region" aria-label="Ferramentas">
  <div class="group">
    <label for="fileIn">Dados (JSON)</label>
    <div class="row">
      <input id="fileIn" type="file" accept=".json,.json5,.txt"/>
      <button id="btnReload">Recarregar</button>
      <button id="btnExportPng">PNG</button>
      <button id="btnExportPdf">PDF</button>
    </div>
    <div class="row">
      <input id="urlIn" type="text" placeholder="ou URL do JSON"/>
      <button id="btnLoadUrl">Carregar URL</button>
    </div>
    <small>Suporta JSON/JSON5 (vírgulas finais, comentários // e /* */).</small>
  </div>

  <div class="group">
    <label for="txtSearch">Buscar</label>
    <div class="row">
      <input id="txtSearch" type="text" placeholder="cliente, ID do canal, cidade…"/>
      <button id="btnClear">Limpar</button>
    </div>
    <div class="row">
      <button id="btnAdd">Adicionar canal</button>
      <label><input id="chkDark" type="checkbox"/> Tema escuro</label>
    </div>
  </div>

  <div class="group">
    <label>Camadas</label>
    <div class="row">
      <button id="btnOSM" aria-pressed="true">OSM</button>
      <button id="btnCarto">Carto Light</button>
      <label><input id="chkBase" type="checkbox" checked/> Mostrar base</label>
    </div>
    <div class="row">
      <label><input id="chkLabels" type="checkbox" checked/> Nomes das cidades</label>
      <label><input id="chkPontos" type="checkbox" checked/> Pontos dos saltos</label>
    </div>
  </div>
</div>

<div class="legend" role="region" aria-label="Legenda">
  <div class="group">
    <label>Clientes</label>
    <div id="legendClients" class="legend-clients"></div>
  </div>
</div>

<div class="credit">Feito com Leaflet • Exporta PNG/PDF • Compensa rotas sobrepostas • Controles de zoom no canto inferior direito</div>

<datalist id="citiesList"></datalist>

<!-- MODAL: Adicionar Canal -->
<div class="modal" id="modalAdd">
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Adicionar canal</h3>
    <div class="row"><label>Cliente</label><input id="addCliente" placeholder="nome do cliente"></div>
    <div class="row"><label>ID do canal</label><input id="addId" placeholder="ex.: STAR1-001"></div>
    <div class="row"><label>Tipo</label>
      <select id="addTipo">
        <option value="proprio">próprio</option>
        <option value="cedido">cedido</option>
        <option value="recebido">recebido</option>
      </select>
    </div>
    <div class="row"><label>Capacidade</label>
      <div class="pillset" id="addCaps">
        <label><input type="radio" name="addCap" value="100G"><span>100G</span></label>
        <label><input type="radio" name="addCap" value="200G"><span>200G</span></label>
        <label><input type="radio" name="addCap" value="300G"><span>300G</span></label>
        <label><input type="radio" name="addCap" value="400G"><span>400G</span></label>
        <label><input type="radio" name="addCap" value="600G"><span>600G</span></label>
        <label><input type="radio" name="addCap" value="800G"><span>800G</span></label>
      </div>
    </div>
    <div class="row"><label>Parceiro</label><input id="addParc" placeholder="habilita quando cedido/recebido"></div>
    <div class="row"><label>Saltos</label>
      <div style="flex:1">
        <div class="chips" id="addSaltosChips"></div>
        <div style="display:flex; gap:8px; margin-top:6px;">
          <input id="addSaltosIn" list="citiesList" placeholder="digite uma cidade e Enter"/>
          <button id="btnAddAddSalto">Adicionar salto</button>
          <button id="btnAddCidade">Nova cidade</button>
        </div>
      </div>
    </div>
    <div class="actions" style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
      <button id="btnCancelAdd">Cancelar</button>
      <button id="btnSaveAdd">Salvar</button>
    </div>
    <div id="addWarn" style="color:#b91c1c; font-size:12px; margin-top:6px;"></div>
  </div>
</div>

<!-- MODAL: Editar Canal -->
<div class="modal" id="modalEdit">
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Editar canal</h3>
    <div class="row"><label>Cliente</label><input id="editCliente" disabled></div>
    <div class="row"><label>ID do canal</label><input id="editId"></div>
    <div class="row"><label>Tipo</label>
      <select id="editTipo">
        <option value="proprio">próprio</option>
        <option value="cedido">cedido</option>
        <option value="recebido">recebido</option>
      </select>
    </div>
    <div class="row"><label>Capacidade</label>
      <div class="pillset" id="editCaps">
        <label><input type="radio" name="editCap" value="100G"><span>100G</span></label>
        <label><input type="radio" name="editCap" value="200G"><span>200G</span></label>
        <label><input type="radio" name="editCap" value="300G"><span>300G</span></label>
        <label><input type="radio" name="editCap" value="400G"><span>400G</span></label>
        <label><input type="radio" name="editCap" value="600G"><span>600G</span></label>
        <label><input type="radio" name="editCap" value="800G"><span>800G</span></label>
      </div>
    </div>
    <div class="row"><label>Parceiro</label><input id="editParc" placeholder="habilita quando cedido/recebido"></div>
    <div class="row"><label>Saltos</label>
      <div style="flex:1">
        <div class="chips" id="editSaltosChips"></div>
        <div style="display:flex; gap:8px; margin-top:6px;">
          <input id="editSaltosIn" list="citiesList" placeholder="digite uma cidade e Enter"/>
          <button id="btnEditAddSalto">Adicionar salto</button>
          <button id="btnEditAddCidade">Nova cidade</button>
        </div>
      </div>
    </div>
    <div class="actions" style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
      <button id="btnDeleteEdit" style="margin-right:auto;background:#fee2e2;border:1px solid #fecaca;color:#991b1b">Excluir canal</button>
      <button id="btnCancelEdit">Cancelar</button>
      <button id="btnSaveEdit">Salvar alterações</button>
    </div>
    <div id="editWarn" style="color:#b91c1c; font-size:12px; margin-top:6px;"></div>
  </div>
</div>

<!-- MODAL: Nova cidade -->
<div class="modal" id="modalCity">
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Adicionar cidade</h3>
    <div class="row"><label>Nome da cidade</label><input id="cityName" placeholder="ex.: Floriano-PI"></div>
    <div class="row"><label>Latitude</label><input id="cityLat" placeholder="-6.7712"></div>
    <div class="row"><label>Longitude</label><input id="cityLng" placeholder="-43.0229"></div>
    <div class="actions" style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
      <button id="btnCancelCity">Cancelar</button>
      <button id="btnSaveCity">Salvar cidade</button>
    </div>
    <div id="cityWarn" style="color:#b91c1c; font-size:12px; margin-top:6px;"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-image/leaflet-image.js"></script>
<script>
'use strict';

const $ = (id)=> document.getElementById(id);
const qs = (sel)=> document.querySelector(sel);

/* ==========================
   Estado global dos dados
==========================*/
let CITY_COORDS = {};
let DATA = { clientes: {} };

/* ==========================
   Utilidades
==========================*/
function normalizeHex(h){ h=(h||'').trim(); if(!/^#/.test(h)) h='#'+h; return h.toUpperCase(); }
function uid(){ return Math.random().toString(36).slice(2,9); }

function addChip(container, city){
  const div=document.createElement('div'); div.className='chip'; div.dataset.city=city; div.innerHTML = `${city} <span class="x" title="remover">×</span>`;
  div.querySelector('.x').onclick=()=> div.remove();
  container.appendChild(div);
}
function getChips(container){ return Array.from(container.querySelectorAll('.chip')).map(x=>x.dataset.city); }
function chipsFromText(t){ return (t||'').split(/[,;\n]+/).map(s=>s.trim()).filter(Boolean); }

function getCoord(city){
  const c=CITY_COORDS[city];
  if(!c) return null;
  return [c.lat, c.lng];
}

function registerUsedColor(hex){ /* placeholder: se quiser bloquear repetição */ }

/* ==========================
   Leaflet: mapa e camadas
==========================*/
let MAP, CANV, BASE_OSM, BASE_CARTO, currentBase;
let LABELS_LAYER, NODES_LAYER, ALL_LINES=[];

function buildMap(){
  MAP = L.map('map', { zoomControl:false, preferCanvas:true, center:[-15.6, -47.4], zoom:4 });
  CANV = L.canvas();

  BASE_OSM   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, crossOrigin:'anonymous' });
  BASE_CARTO = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom:20, crossOrigin:'anonymous' });
  currentBase = BASE_OSM.addTo(MAP);

  L.control.zoom({ position:'bottomright' }).addTo(MAP);

  LABELS_LAYER = L.layerGroup().addTo(MAP);
  NODES_LAYER  = L.layerGroup().addTo(MAP);
}

function waitTilesLoaded(){
  return new Promise(res=>{
    const tl = document.querySelectorAll('.leaflet-tile');
    if(!tl.length) return res();
    let pending=0; tl.forEach(img=>{ if(!img.complete) { pending++; img.addEventListener('load', check); img.addEventListener('error', check); } });
    function check(){ if(--pending<=0) res(); }
    if(pending===0) res();
  });
}

function totalKm(points){
  let d=0; for(let i=1;i<points.length;i++){ d += MAP.distance(points[i-1], points[i]); } return d/1000;
}

/* ==========================
   Renderização
==========================*/
function clearLayers(){ LABELS_LAYER.clearLayers(); NODES_LAYER.clearLayers(); ALL_LINES.forEach(r=>{ r.line.remove(); r.hit.remove(); }); ALL_LINES.length=0; }

function makeOffsetPolyline(points, offsets, style){
  // gera múltiplas linhas com offset para canais sobrepostos
  if(!offsets || !offsets.length) return L.polyline(points, style);
  const group = L.layerGroup();
  offsets.forEach(off=>{
    const shifted = points.map(([lat,lng],i)=>{
      if(i===0||i===points.length-1) return [lat,lng];
      const p=MAP.latLngToLayerPoint([lat,lng]);
      const prev=MAP.latLngToLayerPoint(points[i-1]);
      const next=MAP.latLngToLayerPoint(points[i+1]);
      const vx = next.x - prev.x, vy = next.y - prev.y;
      const len = Math.hypot(vx,vy)||1; const nx = -vy/len, ny = vx/len;
      const q = L.point(p.x + nx*off, p.y + ny*off);
      return MAP.layerPointToLatLng(q);
    });
    L.polyline(shifted, style).addTo(group);
  });
  return group;
}

function render(){
  clearLayers();
  const layer = L.layerGroup().addTo(MAP);
  const bounds=[];

  const showLabels = $('chkLabels').checked;
  const showNodes  = $('chkPontos').checked;

  Object.entries(DATA.clientes||{}).forEach(([cli,obj])=>{
    const color = normalizeHex(obj.color||'#4f46e5');
    const canais = obj.canais||[];

    canais.forEach((canal,i)=>{
      const saltos = (canal.saltos||[]).filter(Boolean);
      const pts = saltos.map(getCoord).filter(Boolean);
      if(pts.length<2) return;

      const offsets = [0, 6, -6, 12, -12, 18, -18];
      const dash = (canal.tipo||'').toLowerCase()==='cedido' ? '4 6' : (canal.tipo||'').toLowerCase()==='recebido' ? '2 8' : null;
      const style={renderer:CANV, color, weight:4, opacity:.98, lineJoin:'round', dashArray:dash, lineCap:'round'};

      const distKm=totalKm(pts);
      const idEdit='e_'+uid(), idHi='h_'+uid(), idCtr='c_'+uid();
      const popupHtml=`<div>
        <b>${(canal.id||'—').toUpperCase()}</b><br>
        Cliente: <b>${cli}</b><br>
        Tipo: <b>${canal.tipo||'próprio'}</b><br>
        Capacidade: <b>${canal.capacidade||'—'}</b><br>
        Parceiro: <b>${canal.parceiro||'—'}</b><br>
        Distância total: <b>${distKm.toFixed(1)} km</b><br>
        Saltos: ${saltos.join(' → ')}<br>
        <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap">
          <button id="${idHi}">Destacar</button>
          <button id="${idCtr}">Centralizar percurso</button>
          <button id="${idEdit}">Editar canal</button>
        </div>
      </div>`;

      const line = makeOffsetPolyline(pts, offsets, style).addTo(layer).bindPopup(popupHtml);
      const hit  = L.polyline(pts, {renderer:CANV, color:'#000', weight:30, opacity:0.001, lineJoin:'round', interactive:true})
                      .addTo(layer).bindPopup(popupHtml);

      const rec = { line, hit, cliente:cli, idx:i, canalRef:canal, pts, saltos,
                    text:(cli+' '+(canal.id||'')+' '+saltos.join(' ')).toLowerCase() };

      function attach(){
        const bE=$('#'+idEdit), bH=$('#'+idHi), bC=$('#'+idCtr);
        if(bE) bE.onclick=()=> openEditModal(cli,i);
        if(bH) bH.onclick=()=> selectRoute(rec,false);
        if(bC) bC.onclick=()=> selectRoute(rec,true);
      };
      line.on('popupopen', attach); hit.on('popupopen', attach);

      function routeClickHandler(ev){
        if (ev.originalEvent && ev.originalEvent.altKey){
          if (L && L.DomEvent) { L.DomEvent.stop(ev); }
          showNearbyRoutes(ev.latlng);
        } else {
          // nada
        }
      }
      line.on('click', routeClickHandler);
      hit.on('click',  routeClickHandler);

      ALL_LINES.push(rec);
      bounds.push(...pts);

      if (showNodes){
        const seen=new Set();
        saltos.forEach(s=>{
          if(s && !seen.has(s)){
            seen.add(s);
            const c = getCoord(s); if(!c) return;
            if(showLabels){ L.marker(c, { interactive:false, keyboard:false }).addTo(LABELS_LAYER).bindTooltip(s,{permanent:true, direction:'right', className:'citylbl'}); }
            if($('chkPontos').checked){ L.circleMarker(c, {radius:3, color:'#111', weight:1, fill:true, fillOpacity:1, fillColor:'#111', interactive:false, renderer:CANV}).addTo(NODES_LAYER); }
          }
        });
      }
    });
  });

  if(bounds.length){ MAP.fitBounds(bounds, { padding:[40,40] }); }
}

function selectRoute(rec, center){
  if(center){ const bb = L.latLngBounds(rec.pts); MAP.fitBounds(bb, { padding:[40,40] }); }
  ALL_LINES.forEach(r=> r.line.setStyle({opacity: r===rec? 1: .15}));
}

function showNearbyRoutes(latlng){
  const THR=8; // pixels
  const p0 = MAP.latLngToLayerPoint(latlng);
  const near = ALL_LINES.filter(r=>{
    return r.pts.some(pt=> MAP.latLngToLayerPoint(pt).distanceTo(p0) <= THR);
  });
  if(!near.length) return;
  ALL_LINES.forEach(r=> r.line.setStyle({opacity: near.includes(r)? 1: .1}));
}

/* ==========================
   UI dinâmica
==========================*/
function rebuildLegend(){
  const cont = $('legendClients'); cont.innerHTML='';
  Object.entries(DATA.clientes||{}).forEach(([cli,obj])=>{
    const row=document.createElement('div'); row.className='row';
    const sw=document.createElement('div'); sw.className='sw'; sw.style.background=normalizeHex(obj.color||'#4f46e5');
    const lbl=document.createElement('label');
    lbl.innerHTML=`<input type="checkbox" data-cli="${cli}" checked> ${cli}`;
    row.append(sw,lbl); cont.appendChild(row);
  });
}

function rebuildCitiesDatalist(){
  const dl = $('citiesList'); dl.innerHTML='';
  Object.keys(CITY_COORDS).sort().forEach(c=>{
    const opt=document.createElement('option'); opt.value=c; dl.appendChild(opt);
  });
}

function highlight(txt){
  txt=(txt||'').toLowerCase().trim();
  ALL_LINES.forEach(r=>{
    const on = !txt || r.text.includes(txt);
    r.line.setStyle({opacity: on? 1: .08});
  });
}

/* ==========================
   Carregar dados (arquivo/URL) com parser tolerante
==========================*/
function sanitizeJsonText(txt){
  if(!txt) return txt;
  txt = txt.replace(/^\uFEFF/, '');              // BOM
  txt = txt.replace(/\/\*[\s\S]*?\*\//g, '')     // /* ... */
           .replace(/(^|[^:])\/\/[^\n\r]*/g, '$1'); // // ...
  txt = txt.replace(/,\s*(?=[}\]])/g, '');       // vírgulas finais
  return txt;
}
async function parseDataText(raw){
  const txt=sanitizeJsonText(raw||'').trim(); if(!txt) throw new Error('vazio');
  try{ return JSON.parse(txt); }catch(e){ return JSON5.parse(txt); }
}

async function loadFromFile(file){
  const raw = await file.text();
  return parseDataText(raw);
}

async function loadFromURL(url){
  const res = await fetch(url); const raw = await res.text();
  return parseDataText(raw);
}

function normalizeInput(json){
  const city = json.CITY_COORDS || json.cidades || json.city_coords || {};
  const data = (json.DATA && json.DATA.clientes) ? json.DATA : (json.clientes? {clientes: json.clientes} : {clientes:{}});
  return { city, data };
}

async function reload(){
  const f=$('fileIn'); const u=$('urlIn').value.trim();
  try{
    let json;
    if(f.files && f.files[0]) json = await loadFromFile(f.files[0]);
    else if(u) json = await loadFromURL(u);
    else json = await (await fetch('mapadwdm.json')).json();

    const {city,data} = normalizeInput(json);
    CITY_COORDS = city; DATA = data; if(!DATA.clientes) DATA.clientes={};
    rebuildLegend(); rebuildCitiesDatalist(); render();
  }catch(e){ console.error(e); alert('Falha ao carregar: '+(e&&e.message||e)); }
}

/* ==========================
   Export PNG / PDF (ajusta bounds e esconde UI)
==========================*/
function withFittedRoutesView(fn){
  const vis = document.body.style.visibility;
  const t1 = document.querySelector('.toolbar');
  const l1 = document.querySelector('.legend');
  const c1 = document.querySelector('.credit');
  const showBase = $('chkBase').checked;
  document.body.style.visibility='visible';
  t1.style.display='none'; l1.style.display='none'; c1.style.display='none';
  if(!showBase && currentBase) currentBase.remove();

  const allPts = ALL_LINES.flatMap(r=> r.pts);
  if(allPts.length) MAP.fitBounds(allPts, {padding:[30,30]});

  return { restore(){
    t1.style.display=''; l1.style.display=''; c1.style.display='';
    if(!showBase && currentBase) currentBase.addTo(MAP);
    document.body.style.visibility=vis;
  }};
}

async function exportPNG(){
  await waitTilesLoaded();
  const ctx=withFittedRoutesView();
  await new Promise(r=> setTimeout(r, 150));
  leafletImage(MAP, function(err, canvas){
    ctx.restore(); if(err){ alert('Erro ao exportar PNG'); return; }
    const a=document.createElement('a'); a.download='mapa.png'; a.href=canvas.toDataURL('image/png'); a.click();
  });
}

async function exportPDF(){
  await waitTilesLoaded();
  const ctx=withFittedRoutesView();
  await new Promise(r=> setTimeout(r, 150));
  leafletImage(MAP, function(err, canvas){
    ctx.restore(); if(err){ alert('Erro ao exportar PDF'); return; }
    const imgData=canvas.toDataURL('image/png');
    const pdf = new window.jspdf.jsPDF('l','pt',[canvas.width, canvas.height]);
    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
    pdf.save('mapa.pdf');
  });
}

/* ==========================
   Modais (Add/Edit/City)
==========================*/
function openAddModal(){
  $('addCliente').value=''; $('addId').value=''; $('addTipo').value='proprio';
  document.querySelectorAll('#addCaps input[type="radio"]').forEach((r,i)=> r.checked=(i===0));
  $('addParc').value=''; $('addParc').disabled=true; $('addSaltosChips').innerHTML=''; $('addSaltosIn').value=''; $('addWarn').textContent='';
  $('modalAdd').style.display='flex';
}
function closeAddModal(){ $('modalAdd').style.display='none'; }
function saveAdd(){
  const cliente=$('addCliente').value.trim(); const id=$('addId').value.trim().toUpperCase(); const tipo=$('addTipo').value;
  const cap=(document.querySelector('#addCaps input:checked')||{}).value||''; const parc=$('addParc').value.trim();
  let saltos=getChips($('addSaltosChips')); if(!saltos.length) saltos=chipsFromText($('addSaltosIn').value);
  if(!cliente||!id||!saltos.length){ $('addWarn').textContent='Preencha Cliente, ID e Saltos.'; return; }
  const unknown=saltos.filter(c=>!getCoord(c)); if(unknown.length){ $('addWarn').textContent='Cidade(s) não encontrada(s): '+unknown.join(', '); return; }
  if(!DATA) DATA={clientes:{}}; if(!DATA.clientes) DATA.clientes={};
  if(!DATA.clientes[cliente]){
    const color = getOrCreateClientColor(cliente);
    DATA.clientes[cliente] = { color, canais: [] };
  } else {
    if (DATA.clientes[cliente].color) registerUsedColor(DATA.clientes[cliente].color);
  }
  DATA.clientes[cliente].canais.push({id,tipo,capacidade:cap,parceiro:parc,saltos});
  closeAddModal(); render(); $('txtSearch').value=id; highlight(id);
}

function openEditModal(cliente,idx){
  const canal=(DATA.clientes[cliente].canais||[])[idx]; if(!canal) return;
  $('editCliente').value=cliente; $('editId').value=(canal.id||'').toUpperCase(); $('editTipo').value=(canal.tipo||'proprio');
  document.querySelectorAll('#editCaps input[type="radio"]').forEach(r=> r.checked=(r.value===(canal.capacidade||'100G')));
  $('editParc').value=canal.parceiro||''; $('editParc').disabled=( $('editTipo').value==='proprio' );
  $('editSaltosChips').innerHTML=''; (canal.saltos||[]).forEach(s=> addChip($('editSaltosChips'), s));
  $('editSaltosIn').value=''; $('editWarn').textContent=''; $('modalEdit').style.display='flex';
  window.__lastEdit={cliente,idx};
}
function closeEditModal(){ $('modalEdit').style.display='none'; }
function saveEdit(){
  const cliente=$('editCliente').value;
  const id=$('editId').value.trim().toUpperCase();
  const tipo=$('editTipo').value;
  const cap=(document.querySelector('#editCaps input:checked')||{}).value||'';
  const parc=$('editParc').value.trim();
  const saltos=getChips($('editSaltosChips'));
  if(!id||!saltos.length){ $('editWarn').textContent='Preencha ID e Saltos.'; return; }
  const unknown=saltos.filter(c=>!getCoord(c));
  if(unknown.length){ $('editWarn').textContent='Cidade(s) não encontrada(s): '+unknown.join(', '); return; }
  const i=(window.__lastEdit&&window.__lastEdit.cliente===cliente)?window.__lastEdit.idx:-1;
  if(i<0 || !DATA || !DATA.clientes || !DATA.clientes[cliente] || !DATA.clientes[cliente].canais || !DATA.clientes[cliente].canais[i]){
    $('editWarn').textContent='Não foi possível localizar o canal para editar.'; return;
  }
  DATA.clientes[cliente].canais[i]={id,tipo,capacidade:cap,parceiro:parc,saltos};
  closeEditModal(); render(); $('txtSearch').value=id; highlight(id);
}

/* ==========================
   Listeners
==========================*/
$('btnAdd').onclick=openAddModal; $('btnCancelAdd').onclick=closeAddModal; $('btnSaveAdd').onclick=saveAdd;
$('addId').oninput=e=> e.target.value=e.target.value.toUpperCase();
$('addTipo').onchange=e=>{ const own=e.target.value==='proprio'; $('addParc').disabled=own; if(own) $('addParc').value=''; };
$('btnAddAddSalto').onclick=()=>{ const c=$('addSaltosIn').value.trim(); if(c){ addChip($('addSaltosChips'), c); $('addSaltosIn').value=''; }};
$('btnAddCidade').onclick=()=> openCityModal(name=> $('addSaltosIn').value=name);

$('btnCancelEdit').onclick=closeEditModal; $('btnSaveEdit').onclick=saveEdit;
$('btnDeleteEdit').onclick=deleteEdit;

function deleteEdit(){
  const cliente=$('editCliente').value;
  const info=window.__lastEdit||{};
  const i=(info&&info.cliente===cliente)?info.idx:-1;
  if(i<0 || !DATA?.clientes?.[cliente]?.canais?.[i]){ $('editWarn').textContent='Canal não encontrado para exclusão.'; return; }
  DATA.clientes[cliente].canais.splice(i,1);
  closeEditModal(); render();
}

$('editId').oninput=e=> e.target.value=e.target.value.toUpperCase();
$('editTipo').onchange=e=>{ const own=e.target.value==='proprio'; $('editParc').disabled=own; if(own) $('editParc').value=''; };
$('btnEditAddSalto').onclick=()=>{ const c=$('editSaltosIn').value.trim(); if(c){ addChip($('editSaltosChips'), c); $('editSaltosIn').value=''; }};
$('btnEditAddCidade').onclick=()=> openCityModal(name=> $('editSaltosIn').value=name);

$('btnCancelCity').onclick=()=> $('modalCity').style.display='none';
$('btnSaveCity').onclick=saveCityFromModal;

$('btnClear').onclick=()=>{ $('txtSearch').value=''; highlight(''); };
$('txtSearch').oninput=(()=>{ let t; return (e)=>{ clearTimeout(t); t=setTimeout(()=> highlight(e.target.value), 250); }; })();

$('btnReload').onclick=reload; $('btnLoadUrl').onclick=reload; $('fileIn').onchange=reload;
$('btnExportPng').onclick=exportPNG; $('btnExportPdf').onclick=exportPDF;

$('btnOSM').onclick=()=>{ if(currentBase) currentBase.remove(); currentBase=BASE_OSM.addTo(MAP); $('btnOSM').setAttribute('aria-pressed','true'); $('btnCarto').setAttribute('aria-pressed','false'); };
$('btnCarto').onclick=()=>{ if(currentBase) currentBase.remove(); currentBase=BASE_CARTO.addTo(MAP); $('btnOSM').setAttribute('aria-pressed','false'); $('btnCarto').setAttribute('aria-pressed','true'); };
$('chkBase').onchange=()=>{ if($('chkBase').checked){ if(currentBase) currentBase.addTo(MAP); } else { if(currentBase) currentBase.remove(); } };
$('chkLabels').onchange=render; $('chkPontos').onchange=render;

function openCityModal(onSave){
  $('cityName').value=''; $('cityLat').value=''; $('cityLng').value=''; $('cityWarn').textContent='';
  $('modalCity').style.display='flex';
  $('btnSaveCity').onclick=function(){
    const name=$('cityName').value.trim(); const lat=parseFloat($('cityLat').value); const lng=parseFloat($('cityLng').value);
    if(!name||Number.isNaN(lat)||Number.isNaN(lng)){ $('cityWarn').textContent='Preencha nome/lat/lng válidos.'; return; }
    CITY_COORDS[name]={lat,lng}; rebuildCitiesDatalist(); $('modalCity').style.display='none'; if(onSave) onSave(name);
  };
}

function saveCityFromModal(){ /* sem uso direto; placeholder */ }

/* ==========================
   Cores de clientes
==========================*/
const USED_COLORS=new Set();
function getOrCreateClientColor(n){
  n=(n||'').trim();
  if(DATA?.clientes?.[n]?.color){ const hx=normalizeHex(DATA.clientes[n].color); registerUsedColor(hx); return hx; }
  let hash=0; for(let i=0;i<n.length;i++) hash=(hash*31 + n.charCodeAt(i))|0; hash=Math.abs(hash);
  const palette=['#2563EB','#059669','#D97706','#EC4899','#7C3AED','#DC2626','#0EA5E9','#059669','#16A34A','#F59E0B','#A855F7','#EF4444'];
  let tryIdx=hash % palette.length; let tries=0;
  while(tries<palette.length){ const hx=normalizeHex(palette[(tryIdx+tries)%palette.length]); if(!USED_COLORS.has(hx)){ USED_COLORS.add(hx); return hx; } tries++; }
  return normalizeHex(palette[hash % palette.length]);
}

/* ==========================
   Bootstrap
==========================*/
buildMap();
reload();

</script>
<!-- jsPDF para exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>

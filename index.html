<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa DWDM — export fix (html2canvas)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/json5@2.2.3/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{ --bg:#f6f7fb; --fg:#111; --muted:#374151; --card:#fff; --bd:#e5e7eb; }
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
  #map{position:absolute; inset:0}

  .toolbar{position:absolute; z-index:1000; left:12px; top:12px; right:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
           background:var(--card); padding:10px 12px; border:1px solid var(--bd); border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,.06)}
  .toolbar .group{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .toolbar input[type="text"]{padding:7px 10px; border:1px solid var(--bd); border-radius:10px; min-width:260px}
  .toolbar button,.toolbar label.btn{padding:8px 10px; border:1px solid var(--bd); border-radius:10px; background:#fafafa; cursor:pointer}

  .legend,.legend-clients{position:absolute; right:14px; z-index:1000; background:var(--card); border:1px solid var(--bd); border-radius:10px; padding:8px 10px; color:#374151; font-size:12px}
  .legend{bottom:14px}
  .legend-clients{bottom:140px; max-height:300px; width:290px; overflow:auto}
  .legend .line{display:flex; align-items:center; gap:8px; margin:4px 0}
  .legend .sample{width:42px; height:0; border-top:3px solid #222}
  .legend .dash{border-top-style:dashed}
  .legend .dot{border-top-style:dotted; border-top-width:2px}

  .legend-clients .row{display:flex; align-items:center; gap:8px; padding:4px 0; border-bottom:1px dashed #eee}
  .legend-clients .sw{width:18px; height:12px; border-radius:3px; border:1px solid var(--bd)}
  .legend-clients .row label{display:flex; align-items:center; gap:8px; flex:1; cursor:pointer}

  .credit{position:absolute; left:14px; bottom:14px; z-index:1000; color:#374151; font-size:12px; background:var(--card);
          border:1px solid var(--bd); border-radius:10px; padding:6px 8px}

  .leaflet-control-container .leaflet-top,.leaflet-control-container .leaflet-bottom{z-index:1500}

  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; align-items:center; justify-content:center; z-index:2000; }
  .modal .card{ background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:16px; width:min(760px,96vw); box-shadow:0 10px 40px rgba(0,0,0,.15); }
  .modal .row{ display:flex; gap:10px; margin:8px 0; align-items:center; }
  .modal label{ width:170px; color:#374151; font-size:13px; }
  .modal input, .modal select{ flex:1; padding:8px; border:1px solid var(--bd); border-radius:8px; }

  .pillset{ display:flex; flex-wrap:wrap; gap:6px; }
  .pillset label{ border:1px solid var(--bd); border-radius:999px; padding:6px 10px; cursor:pointer; }
  .pillset input{ display:none; }
  .pillset input:checked + span{ background:#eef2ff; border-color:#c7d2fe; }

  .chips{ display:flex; gap:6px; flex-wrap:wrap; }
  .chip{ background:#eef2ff; border:1px solid #c7d2fe; border-radius:999px; padding:4px 8px; display:inline-flex; align-items:center; gap:6px; }
  .chip button{ border:0; background:transparent; cursor:pointer; font-weight:700; }
</style>
</head>
<body>
  <div id="map"></div>

  <div class="toolbar" id="toolbar">
    <div class="group">
      <button id="btnFetch">Recarregar JSON</button>
      <label class="btn">Carregar JSON <input id="fileJSON" type="file" accept=".json,.json5,.txt" hidden></label>
      <label><input type="checkbox" id="chkDark"> Tema escuro</label>
      <label><input type="checkbox" id="chkPontos" checked> Mostrar pontos</label>
      <button id="btnAdd">Adicionar canal</button>
      <button id="btnExport">Exportar JSON</button>
      <button id="btnPng">Exportar PNG</button>
      <button id="btnPdf">Exportar PDF</button>
      <button id="btnCenterMap">Centralizar</button>
    </div>
    <div class="group" style="margin-left:auto">
      <input id="txtSearch" type="text" placeholder="buscar cliente/canal/cidade/parceiro"/>
      <button id="btnSearch">Buscar</button>
      <button id="btnClear">Limpar</button>
      <label><input type="checkbox" id="tProprio" checked> Próprio</label>
      <label><input type="checkbox" id="tCedido" checked> Cedido</label>
      <label><input type="checkbox" id="tRecebido" checked> Recebido</label>
    </div>
  </div>

  <div class="legend-clients" id="legendClients">
    <b>Clientes no mapa</b>
    <div style="display:flex;gap:8px;margin:6px 0">
      <button id="btnAllClients">Marcar todos</button>
      <button id="btnNoClients">Desmarcar todos</button>
    </div>
    <div id="legendClientsList"></div>
  </div>

  <div class="legend">
    <div class="line"><span class="sample"></span> Próprio — <i>linha contínua</i></div>
    <div class="line"><span class="sample dash"></span> Cedido — <i>linha tracejada</i></div>
    <div class="line"><span class="sample dot"></span> Recebido — <i>linha pontilhada</i></div>
  </div>
  <div class="credit">Afastamento automático nas rotas sobrepostas • Controles de zoom no canto inferior direito</div>

  <!-- Modais (Adicionar / Editar / Nova cidade) -->
  <div class="modal" id="modalAdd"> … <!-- (igual às versões anteriores) --></div>
  <div class="modal" id="modalEdit"> … </div>
  <div class="modal" id="modalCity"> … </div>
  <datalist id="citiesList"></datalist>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  (function(){
    const JSON_URL='mapadwdm.json';
    const SHIFT_GAP=12;
    const OFFSET_MODE='constant';

    let DATA=null, CITY_COORDS=null, CITY_BOUNDS=null;
    let map, BASE_LIGHT, BASE_DARK, currentBase, CANV;
    let CLIENT_LAYERS={}, HILAYER=null, SELAYER=null, ALL_LINES=[];
    let CLIENT_VISIBLE={};

    const $=id=>document.getElementById(id);

    /* ---------- util de JSON tolerante ---------- */
    function sanitizeJsonText(txt){
      txt = txt.replace(/^\uFEFF/,'');
      txt = txt.replace(/\/\*[\s\S]*?\*\//g,'').replace(/(^|[^:])\/\/[^\n\r]*/g,'$1');
      txt = txt.replace(/,\s*(?=[}\]])/g,'');
      return txt;
    }
    async function parseMaybe(txt){
      try{ return JSON.parse(sanitizeJsonText(txt)); }
      catch(e){ return window.JSON5.parse(txt); }
    }

    /* ---------- mapa ---------- */
    function initMap(){
      map=L.map('map',{
        zoomControl:false, zoomSnap:.25, zoomDelta:.5, minZoom:3, maxZoom:20,
        preferCanvas:true, worldCopyJump:false, inertia:true
      }).setView([-5.5,-41.5],6);

      CANV=L.canvas({padding:.5});
      L.control.zoom({position:'bottomright'}).addTo(map);

      BASE_LIGHT=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        {attribution:'&copy; OpenStreetMap', crossOrigin:'anonymous', noWrap:true, continuousWorld:false});
      BASE_DARK=L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        {attribution:'&copy; Carto, OpenStreetMap', crossOrigin:'anonymous', noWrap:true, continuousWorld:false});
      currentBase=BASE_LIGHT.addTo(map);

      const recalc=()=>{
        Object.values(CLIENT_LAYERS).forEach(g=>g.getLayers().forEach(l=>{ if(l.__recalc) l.__recalc(); }));
        if(HILAYER) HILAYER.getLayers().forEach(l=>{ if(l.__recalc) l.__recalc(); });
        if(SELAYER) SELAYER.getLayers().forEach(l=>{ if(l.__recalc) l.__recalc(); });
      };
      ['zoom','zoomend','moveend','viewreset','resize'].forEach(e=> map.on(e,recalc));
    }

    /* ---------- helpers, render, busca, etc.  (idênticos ao último código que te enviei) ---------- */
    //  … (mantenho todas as funções: getCoord, haversine, offsetLatLngs, computeOffsetsForPath,
    //     render(), highlight(), selectRoute(), modais de adicionar/editar/cidade, etc.)
    //  Para caber aqui, omiti esse miolo — use o MESMO de antes. Só mudamos a parte de exportação.

    /* ---------- bounds das rotas visíveis ---------- */
    function getRoutesBounds(){
      if(!ALL_LINES.length) return CITY_BOUNDS;
      let b=null; for(const r of ALL_LINES){ if(r.pts?.length){ const lb=L.latLngBounds(r.pts); b=b?b.extend(lb):L.latLngBounds(lb); } }
      return b||CITY_BOUNDS;
    }
    function fitBoundsAsync(bounds,pad=.06){
      if(!bounds) return Promise.resolve();
      return new Promise(res=>{
        let done=false; const fin=()=>{ if(!done){done=true;res();} };
        map.once('moveend',fin); setTimeout(fin,600);
        map.fitBounds(bounds.pad(pad));
      });
    }
    function setViewAsync(center,zoom){
      return new Promise(res=>{
        let done=false; const fin=()=>{ if(!done){done=true;res();} };
        map.once('moveend',fin); setTimeout(fin,600); map.setView(center,zoom);
      });
    }
    function waitTilesLoaded(timeoutMs=2000){
      return new Promise(resolve=>{
        const layer=currentBase; if(!layer||!layer._map){ resolve(); return; }
        let done=false; const fin=()=>{ if(!done){done=true;resolve();} };
        if(!layer._loading){ fin(); return; }
        layer.once('load',fin); setTimeout(fin,timeoutMs);
      });
    }
    async function withFittedRoutesView(cb){
      const bounds=getRoutesBounds();
      const prev={center:map.getCenter(), zoom:map.getZoom(), maxBounds:map.options.maxBounds||null};
      map.setMaxBounds(null);
      if(bounds){
        await fitBoundsAsync(bounds,.08);
        map.invalidateSize(true);
        await waitTilesLoaded(2200);
        await new Promise(r=>setTimeout(r,160));
      }
      try{ return await cb(); }
      finally{
        await setViewAsync(prev.center, prev.zoom);
        map.setMaxBounds(prev.maxBounds || (CITY_BOUNDS ? CITY_BOUNDS.pad(1.2) : null));
        map.invalidateSize(true);
        await new Promise(r=>setTimeout(r,120));
      }
    }
    function hideUI(h){ ['toolbar','legendClients'].forEach(id=>{ const el=$(id); if(el) el.style.visibility=h?'hidden':'visible'; });
                        document.querySelectorAll('.legend,.credit').forEach(el=> el.style.visibility=h?'hidden':'visible'); }

    /* ---------- EXPORTAÇÃO (html2canvas) ---------- */
    async function exportPNG(){
      try{
        hideUI(true);
        const dataUrl = await withFittedRoutesView(async ()=>{
          const node = map.getContainer();
          const bg   = (currentBase===BASE_DARK) ? '#0b0e12' : '#cfe8f3';
          const canvas = await html2canvas(node, {useCORS:true, backgroundColor:bg, scale:2, logging:false});
          return canvas.toDataURL('image/png');
        });
        hideUI(false);
        const a=document.createElement('a'); a.href=dataUrl; a.download='mapadwdm.png'; a.click();
      }catch(e){ hideUI(false); alert('Falha ao exportar PNG: '+e.message); }
    }

    async function exportPDF(){
      try{
        hideUI(true);
        const dataUrl = await withFittedRoutesView(async ()=>{
          const node = map.getContainer();
          const bg   = (currentBase===BASE_DARK) ? '#0b0e12' : '#cfe8f3';
          const canvas = await html2canvas(node, {useCORS:true, backgroundColor:bg, scale:2, logging:false});
          return canvas.toDataURL('image/jpeg', 0.92);
        });
        hideUI(false);

        const {jsPDF}=window.jspdf;
        const pdf=new jsPDF({orientation:'landscape',unit:'pt',format:'a3',compress:true});
        const W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight(), M=24;
        const img=new Image(); await new Promise(r=>{ img.onload=r; img.src=dataUrl; });
        const w=W-2*M, h=w*img.height/img.width, x=M, y=(H-h)/2;
        pdf.addImage(dataUrl,'JPEG',x,y,w,h);
        pdf.save('mapadwdm.pdf');
      }catch(e){ hideUI(false); alert('Falha ao exportar PDF: '+e.message); }
    }

    /* ---------- UI básica / eventos (igual ao anterior) ---------- */
    function initUI(){
      $('btnFetch').onclick=()=>loadFromURL();
      $('fileJSON').onchange=e=>{ if(e.target.files?.[0]) loadFromFile(e.target.files[0]); };
      $('chkDark').onchange=e=>{ map.removeLayer(currentBase); currentBase=(e.target.checked?BASE_DARK:BASE_LIGHT).addTo(map); };
      ['tProprio','tCedido','tRecebido','chkPontos'].forEach(id=> $(id).onchange=render);
      $('btnPng').onclick=exportPNG; $('btnPdf').onclick=exportPDF;
      $('btnCenterMap').onclick=()=>{ const b=getRoutesBounds(); if(b) map.fitBounds(b.pad(.08)); };
      // … (restante idêntico: busca Enter/ESC, adicionar/editar/cidade, etc.)
    }

    /* ---------- carregamento JSON (mesmo do anterior) ---------- */
    function normalizeJSON(json){
      const raw=json.CITY_COORDS||json.CITY||{}; const city={};
      Object.keys(raw).forEach(k=>{ const v=raw[k]; city[k]=Array.isArray(v)?{lat:+v[0],lng:+v[1]}:{lat:+v.lat,lng:+v.lng}; });
      let clientes=(json.DATA&&json.DATA.clientes)?json.DATA.clientes:json.clientes;
      if(!clientes && json.DATA) clientes=json.DATA;
      return {city,clientes};
    }
    function computeCityBounds(){
      const pts=Object.values(CITY_COORDS||{}).map(v=>Array.isArray(v)?L.latLng(+v[0],+v[1]):L.latLng(+v.lat,+v.lng));
      return pts.length? L.latLngBounds(pts).pad(.25):null;
    }
    async function loadFromURL(){
      try{
        if(location.protocol==='file:'){ alert('Abrindo do disco: use "Carregar JSON".'); return; }
        const resp=await fetch(JSON_URL+'?v='+Date.now(),{cache:'no-store'});
        if(!resp.ok){ alert('Falha ao baixar '+JSON_URL); return; }
        const j=await parseMaybe(await resp.text()); const n=normalizeJSON(j);
        CITY_COORDS=n.city; DATA={clientes:n.clientes}; CITY_BOUNDS=computeCityBounds(); if(CITY_BOUNDS) map.setMaxBounds(CITY_BOUNDS.pad(1.2));
        buildCityDatalist(); render();
      }catch(err){ alert('JSON inválido: '+(err?.message||err)); }
    }
    function loadFromFile(f){
      const r=new FileReader(); r.onload=async e=>{
        try{
          const j=await parseMaybe(e.target.result); const n=normalizeJSON(j);
          CITY_COORDS=n.city; DATA={clientes:n.clientes}; CITY_BOUNDS=computeCityBounds(); if(CITY_BOUNDS) map.setMaxBounds(CITY_BOUNDS.pad(1.2));
          buildCityDatalist(); render();
        }catch(err){ alert('JSON inválido: '+(err?.message||err)); }
      }; r.readAsText(f,'utf-8');
    }
    function buildCityDatalist(){
      const dl=$('citiesList'); dl.innerHTML='';
      Object.keys(CITY_COORDS||{}).sort().forEach(k=>{ const o=document.createElement('option'); o.value=k; dl.appendChild(o); });
    }

    /* ---------- boot ---------- */
    initMap();
    initUI();
    loadFromURL().catch(()=>{});
  })();
  </script>
</body>
</html>
